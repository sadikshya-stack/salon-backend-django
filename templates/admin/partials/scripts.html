{% comment %} <script>
    (function () {
        const spinner = document.getElementById('spinner');
        if (spinner) {
            setTimeout(() => {
                spinner.classList.remove('show');
            }, 300);
        }
    })();
</script> {% endcomment %}


 <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0.0/jquery.counterup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

    <script src="https://cdn.jsdelivr.net/parallax.js/1.4.2/parallax.min.js"></script>

    {% block extra_js %}{% endblock %}

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    
    <script>
        // Toggle Sidebar
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            document.getElementById('adminSidebar').classList.toggle('show');
            document.querySelector('.admin-main').classList.toggle('full-width');
            document.querySelector('.admin-toggle-sidebar i').classList.toggle('fa-bars');
            document.querySelector('.admin-toggle-sidebar i').classList.toggle('fa-times');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('adminSidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            if (window.innerWidth <= 992 && !sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                sidebar.classList.remove('show');
                document.querySelector('.admin-toggle-sidebar i').classList.add('fa-bars');
                document.querySelector('.admin-toggle-sidebar i').classList.remove('fa-times');
            }
        });
        
        // Spinner
        var spinner = function() {
            setTimeout(function() {
                if ($('#spinner').length > 0) {
                    $('#spinner').removeClass('show');
                }
            }, 1);
        };
        spinner();

        // Inventory Management System
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize inventory data from localStorage or use sample data
            let inventory = JSON.parse(localStorage.getItem('beautyParlourInventory')) || [];
            
            // DOM Elements
            const inventoryTableBody = document.getElementById('inventoryTableBody');
            const addInventoryBtn = document.getElementById('addInventoryBtn');
            const saveInventoryItemBtn = document.getElementById('saveInventoryItem');
            const inventoryItemModal = new bootstrap.Modal(document.getElementById('inventoryItemModal'));
            const inventoryItemForm = document.getElementById('inventoryItemForm');
            const categoryFilter = document.getElementById('categoryFilter');
            const stockFilter = document.getElementById('stockFilter');
            const inventorySearch = document.getElementById('inventorySearch');
            const searchBtn = inventorySearch.nextElementSibling;
            
            // Event Listeners
            addInventoryBtn.addEventListener('click', openAddModal);
            saveInventoryItemBtn.addEventListener('click', saveInventoryItem);
            categoryFilter.addEventListener('change', filterInventory);
            stockFilter.addEventListener('change', filterInventory);
            searchBtn.addEventListener('click', filterInventory);
            inventorySearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') filterInventory();
            });
            
            // Navigation to Inventory Section
            const inventoryNavLink = document.querySelector('a[href="inventory.html"]');
            if (inventoryNavLink) {
                inventoryNavLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Hide all sections
                    document.querySelectorAll('.admin-content').forEach(section => {
                        section.style.display = 'none';
                    });
                    // Show inventory section
                    document.getElementById('inventorySection').style.display = 'block';
                    // Update active nav link
                    document.querySelectorAll('.admin-nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            }
            
            // Initialize the inventory table
            renderInventoryTable();
            updateStatistics();
            
            // Functions
            function renderInventoryTable(items = null) {
                const inventoryToRender = items || inventory;
                inventoryTableBody.innerHTML = '';
                
                if (inventoryToRender.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-box-open fa-2x mb-2 text-muted"></i>
                            <p class="mb-0">No inventory items found</p>
                            <button class="btn btn-primary btn-sm mt-2" id="addFirstItem">
                                <i class="fas fa-plus me-1"></i> Add Your First Item
                            </button>
                        </td>
                    `;
                    inventoryTableBody.appendChild(row);
                    
                    // Add event listener to the "Add Your First Item" button
                    const addFirstItemBtn = document.getElementById('addFirstItem');
                    if (addFirstItemBtn) {
                        addFirstItemBtn.addEventListener('click', openAddModal);
                    }
                    
                    return;
                }
                
                inventoryToRender.forEach(item => {
                    const row = document.createElement('tr');
                    const status = getStockStatus(item.quantity, item.minStock);
                    const statusClass = {
                        'In Stock': 'bg-success',
                        'Low Stock': 'bg-warning',
                        'Out of Stock': 'bg-danger'
                    }[status];
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="inventory-item-img me-3">
                                    <i class="fas fa-box text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${item.name}</h6>
                                    <small class="text-muted">${item.description || 'No description'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${getCategoryName(item.category)}</td>
                        <td>NPR ${parseFloat(item.price).toFixed(2)}</td>
                        <td>${item.quantity} ${item.quantity === 1 ? 'unit' : 'units'}</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-1 edit-item" data-id="${item.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-item" data-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    inventoryTableBody.appendChild(row);
                });
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-item').forEach(btn => {
                    btn.addEventListener('click', () => openEditModal(btn.dataset.id));
                });
                
                document.querySelectorAll('.delete-item').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.id));
                });
            }
            
            function getStockStatus(quantity, minStock) {
                if (quantity <= 0) return 'Out of Stock';
                if (quantity <= minStock) return 'Low Stock';
                return 'In Stock';
            }
            
            
            function updateStatistics() {
                const totalProducts = inventory.length;
                const inStock = inventory.filter(item => item.quantity > 0 && item.quantity > item.minStock).length;
                const lowStock = inventory.filter(item => item.quantity > 0 && item.quantity <= item.minStock).length;
                const outOfStock = inventory.filter(item => item.quantity <= 0).length;
                
                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('inStockItems').textContent = inStock;
                document.getElementById('lowStockItems').textContent = lowStock;
                document.getElementById('outOfStockItems').textContent = outOfStock;
            }
            
            function openAddModal() {
                document.getElementById('inventoryModalTitle').textContent = 'Add New Item';
                inventoryItemForm.reset();
                document.getElementById('itemId').value = '';
                inventoryItemModal.show();
            }
            
            function openEditModal(id) {
                const item = inventory.find(item => item.id === id);
                if (!item) return;
                
                document.getElementById('inventoryModalTitle').textContent = 'Edit Item';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemQuantity').value = item.quantity;
                document.getElementById('itemMinStock').value = item.minStock || 5;
                document.getElementById('itemDescription').value = item.description || '';
                
                inventoryItemModal.show();
            }
            
            function saveInventoryItem() {
                const id = document.getElementById('itemId').value;
                const name = document.getElementById('itemName').value.trim();
                const category = document.getElementById('itemCategory').value;
                const price = parseFloat(document.getElementById('itemPrice').value);
                const quantity = parseInt(document.getElementById('itemQuantity').value);
                const minStock = parseInt(document.getElementById('itemMinStock').value);
                const description = document.getElementById('itemDescription').value.trim();
                
                // Validation
                if (!name || isNaN(price) || isNaN(quantity) || isNaN(minStock)) {
                    alert('Please fill in all required fields with valid values.');
                    return;
                }
                
                const itemData = {
                    id: id || generateId(),
                    name,
                    category,
                    price,
                    quantity,
                    minStock,
                    description: description || ''
                };
                
                if (id) {
                    // Update existing item
                    const index = inventory.findIndex(item => item.id === id);
                    if (index !== -1) {
                        inventory[index] = itemData;
                    }
                } else {
                    // Add new item
                    inventory.push(itemData);
                }
                
                // Save to localStorage
                localStorage.setItem('beautyParlourInventory', JSON.stringify(inventory));
                
                // Update UI
                renderInventoryTable();
                updateStatistics();
                inventoryItemModal.hide();
                
                // Show success message
                showAlert('success', `Item ${id ? 'updated' : 'added'} successfully!`);
            }
            
            function deleteItem(id) {
                if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
                    inventory = inventory.filter(item => item.id !== id);
                    localStorage.setItem('beautyParlourInventory', JSON.stringify(inventory));
                    renderInventoryTable();
                    updateStatistics();
                    showAlert('success', 'Item deleted successfully!');
                }
            }
            
            function filterInventory() {
                const category = categoryFilter.value;
                const stockStatus = stockFilter.value;
                const searchTerm = inventorySearch.value.toLowerCase();
                
                let filteredItems = [...inventory];
                
                // Filter by category
                if (category) {
                    filteredItems = filteredItems.filter(item => item.category === category);
                }
                
                // Filter by stock status
                if (stockStatus) {
                    filteredItems = filteredItems.filter(item => {
                        const status = getStockStatus(item.quantity, item.minStock).toLowerCase().replace(' ', '-');
                        return status === stockStatus;
                    });
                }
                
                // Filter by search term
                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) || 
                        (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                        item.category.toLowerCase().includes(searchTerm)
                    );
                }
                
                renderInventoryTable(filteredItems);
            }
            
            function generateId() {
                return 'item-' + Math.random().toString(36).substr(2, 9);
            }
            
            function showAlert(type, message) {
                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
                alertDiv.role = 'alert';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add to body
                document.body.appendChild(alertDiv);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            }
            
            // Add sample data if inventory is empty (for demo purposes)
            if (inventory.length === 0) {
                const sampleData = [
                    {
                        id: 'item-1',
                        name: 'Shampoo',
                        category: 'hair',
                        price: 12.99,
                        quantity: 15,
                        minStock: 5,
                        description: 'Moisturizing shampoo for all hair types'
                    },
                    {
                        id: 'item-2',
                        name: 'Conditioner',
                        category: 'hair',
                        price: 14.99,
                        quantity: 3,
                        minStock: 5,
                        description: 'Nourishing conditioner for smooth hair'
                    },
                    {
                        id: 'item-3',
                        name: 'Facial Cleanser',
                        category: 'skin',
                        price: 18.50,
                        quantity: 8,
                        minStock: 3,
                        description: 'Gentle cleanser for all skin types'
                    },
                    {
                        id: 'item-4',
                        name: 'Nail Polish Set',
                        category: 'nails',
                        price: 24.99,
                        quantity: 0,
                        minStock: 2,
                        description: 'Set of 6 nail polish colors'
                    },
                    {
                        id: 'item-5',
                        name: 'Hair Dryer',
                        category: 'tools',
                        price: 89.99,
                        quantity: 2,
                        minStock: 1,
                        description: 'Professional hair dryer with multiple heat settings'
                    }
                ];
                
                inventory = sampleData;
                localStorage.setItem('beautyParlourInventory', JSON.stringify(inventory));
                renderInventoryTable();
                updateStatistics();
            }
        });
    </script>